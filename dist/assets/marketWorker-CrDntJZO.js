function h(a){if(a.length===0)return"CRAB";const t=a.slice(0,10);let n=0,r=0;for(let c=0;c<t.length;c++){const l=t[c].marketCap>0?t[c].marketCap:1;n+=l,r+=t[c].change24h*l}const e=n>0?r/n:0,o=a.slice(0,20);let s=0;for(let c=0;c<o.length;c++)o[c].change24h>0&&s++;const i=o.length>0?s/o.length:.5;return e>5||e>3&&i>.75?"SURGE":e>1.5&&i>.55?"BULL":e<-1.5&&i<.45?"BEAR":"CRAB"}function g(a){const t=a.slice(0,15);let n=0,r=0;for(let o=0;o<t.length;o++){const s=t[o],i=s.marketCap>0?Math.log(s.marketCap):1;n+=(s.change24h*.6+(s.change7d??0)*.4)*i,r+=i}const e=r>0?n/r:0;return e>6?"STRONG_BUY":e>2?"BUY":e<-6?"STRONG_SELL":e<-2?"SELL":"NEUTRAL"}function u(a,t,n){const r=n==="asc"?1:-1;return[...a].sort((e,o)=>{if(t==="name")return r*e.name.localeCompare(o.name);const s=e,i=o,c=s[t]??0,l=i[t]??0;return r*(c-l)})}function p(a,t){if(!t.trim())return a;const n=t.toLowerCase();return a.filter(r=>r.name.toLowerCase().includes(n)||r.symbol.toLowerCase().includes(n))}function m(a,t){const n=new Array(a.length);for(let r=0;r<a.length;r++){const e=a[r],o=e.symbol.toLowerCase()+"usdt",s=t[o];s?n[r]={id:e.id,symbol:e.symbol,name:e.name,price:s.price,change24h:s.change24h,change7d:e.change7d,change30d:e.change30d,marketCap:e.marketCap,volume24h:s.volume24h??e.volume24h,high24h:s.high24h??e.high24h,low24h:s.low24h??e.low24h,circulatingSupply:e.circulatingSupply,totalSupply:e.totalSupply,ath:e.ath,athDate:e.athDate,rank:e.rank,image:e.image,sparkline:e.sparkline,lastUpdated:e.lastUpdated,priceDirection:s.direction??"neutral"}:n[r]=e}return n}self.onmessage=a=>{const t=a.data;try{switch(t.type){case"COMPUTE_MARKET":{self.postMessage({type:"MARKET_RESULT",regime:h(t.assets),signal:g(t.assets)});break}case"SORT_FILTER":{const n=p(t.assets,t.query),r=u(n,t.sortKey,t.sortDir);self.postMessage({type:"SORT_FILTER_RESULT",assets:r});break}case"MERGE_PRICES":{const n=m(t.assets,t.updates);self.postMessage({type:"MERGE_RESULT",assets:n,regime:h(n),signal:g(n)});break}}}catch(n){self.postMessage({type:"ERROR",message:String(n)})}};
